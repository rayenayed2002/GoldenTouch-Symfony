{% extends 'front.html.twig' %}

{% block title %}Custom Page Title{% endblock %}

{% block content %}
<div class="custom-content">
 <section class="space-top space-extra-bottom">
    <div class="container">
        <div class="row flex-row-reverse">
            <!-- ðŸŸ¦ MAIN CONTENT (EVENTS) -->
            <div class="col-xl-9 col-lg-8">
                <div class="th-sort-bar">
                    <div class="row justify-content-between align-items-center">
                        <div class="col-md">
                            <p class="woocommerce-result-count">
                                Showing {{ events|length }} results
                            </p>
                        </div>
                        <div class="col-md-auto">
                            <form class="woocommerce-ordering" method="get">
                                <select name="orderby" class="orderby" aria-label="Shop order">
                                    <option value="menu_order" selected>Default Sorting</option>
                                    <option value="date">Sort by latest</option>
                                    <option value="name">Sort by name</option>
                                    <option value="category">Sort by category</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="row gy-40">
                    {% for event in events %}
                        <div class="col-xl-4 col-sm-6">
                            <a href="{{ path('event_show', {'id': event.id}) }}" class="text-decoration-none">

                             <div class="th-product event-card" 
             data-event-id="{{ event.id }}"
             data-categorie="{{ event.categorie.value }}"
             data-date="{{ event.date|date('Y-m-d') }}">
                                <div class="product-img">
                                    {% if event.photo %}
                                        <img src="{{ asset('uploads/' ~ event.photo) }}" class="img-fluid" alt="{{ event.nom }}">
                                    {% else %}
                                        <img src="assets/img/placeholder.jpg" class="img-fluid" alt="No image">
                                    {% endif %}
                                </div>
                                <div class="product-content">
                                    <h3 class="product-title">
                                        {{ event.nom }}
                                    </h3>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="price">{{ event.date|date('M d, Y') }}</span>
                                        <span class="event-category">
                                            {{ categoryLabels[event.categorie.value] ?? 'General' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                                </a>
                        </div>
                    {% else %}
                        <div class="col-12">
                            <div class="alert alert-info">No events found</div>
                        </div>
                    {% endfor %}
                </div>

                <div class="th-pagination text-center pt-50">
                    <ul>
                        <li><a href="blog.html">1</a></li>
                        <li><a href="blog.html">2</a></li>
                        <li><a href="blog.html">3</a></li>
                        <li><a href="blog.html"><i class="far fa-arrow-right"></i></a></li>
                    </ul>
                </div>
            </div>

            <!-- ðŸŸ¨ SIDEBAR -->
            <div class="col-xl-3 col-lg-4">
                <aside class="sidebar-area sidebar-shop">
                    <div class="widget widget_search">
                        <form class="search-form">
                            <input type="text" placeholder="Search...">
                            <button type="submit"><i class="far fa-search"></i></button>
                        </form>
                    </div>

                    <div class="widget widget_categories">
                        <h3 class="widget_title">Categories</h3>
                        <ul>
                            <li><a href="blog.html">Business Taxi</a> <span>(8)</span></li>
                            <li><a href="blog.html">Corporate Events</a> <span>(6)</span></li>
                            <li><a href="blog.html">Custom Booking</a> <span>(5)</span></li>
                            <li><a href="blog.html">Traveling</a> <span>(2)</span></li>
                            <li><a href="blog.html">Cab Booking Trips</a> <span>(7)</span></li>
                            <li><a href="blog.html">Hybrid Taxi</a> <span>(9)</span></li>
                        </ul>
                    </div>

                    <div class="widget widget_price_filter">
                        <h4 class="widget_title">Filter By Price</h4>
                        <div class="price_slider_wrapper">
                            <div class="price_label">
                                Price: <span class="from">$0</span> â€” <span class="to">$70</span>
                            </div>
                            <div class="price_slider"></div>
                            <button type="submit" class="button">Filter</button>
                        </div>
                    </div>

                    <div class="widget widget_tag_cloud">
                        <h3 class="widget_title">Popular Tags</h3>
                        <div class="tagcloud">
                            <a href="blog.html">Technology</a>
                            <a href="blog.html">Advice</a>
                            <a href="blog.html">Solution</a>
                            <a href="blog.html">Consultion</a>
                            <a href="blog.html">Business</a>
                            <a href="blog.html">IT-Services</a>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>
</div>
{% endblock %}















{% block inline_scripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to update cart count from server
    async function updateCartCount() {
        try {
            const response = await fetch('{{ path('app_panier_count') }}');
            const data = await response.json();
            document.querySelector('.badge').textContent = data.count;
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    // Initial cart count update
    updateCartCount();

    // Make event cards draggable
    document.querySelectorAll('.event-card').forEach(card => {
        card.draggable = true;
        
        card.addEventListener('dragstart', (e) => {
            const eventData = {
                idEvent: card.dataset.eventId,
                categorie: card.dataset.categorie,
                date: card.dataset.date
            };
            e.dataTransfer.setData('application/json', JSON.stringify(eventData));
        });
    });

    // Handle drop on shopping bag
    const shoppingBag = document.querySelector('#cartIcon');
    
    shoppingBag.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    shoppingBag.addEventListener('drop', async (e) => {
        e.preventDefault();
        const eventData = JSON.parse(e.dataTransfer.getData('application/json'));
        
        try {
            const response = await fetch('{{ path('app_panier_add') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            });

            // Handle non-JSON responses
            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch {
                throw new Error('Invalid server response');
            }

            if (result.success) {
                // Update cart count immediately
                const countResponse = await fetch('{{ path('app_panier_count') }}');
                const countData = await countResponse.json();
                document.querySelector('.badge').textContent = countData.count;

                // Find and remove the card
                const cardToRemove = document.querySelector(
                    `.event-card[data-event-id="${eventData.idEvent}"]`
                );
                
                if (cardToRemove) {
                    const columnParent = cardToRemove.closest('.col-xl-4');
                    columnParent.style.transition = 'all 0.3s ease';
                    columnParent.style.opacity = '0';
                    columnParent.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        columnParent.remove();
                        // Update layout after removal
                        const row = document.querySelector('.row.gy-40');
                        if (row) {
                            row.style.display = 'none';
                            row.offsetHeight; // Trigger reflow
                            row.style.display = '';
                        }
                    }, 300);
                }
            } else {
                alert('Error: ' + (result.message || 'Failed to add to cart'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add to cart: ' + error.message);
        }
    });
});
</script>
{% endblock %}